name: CI

on:
    push:
        branches:
            - master
    pull_request:
    workflow_dispatch: # Allows manual triggering

jobs:
    build:
        strategy:
            fail-fast: true
            matrix:
                hostname:
                    - edge
                    - pangolin

        runs-on: ubuntu-latest

        permissions:
            id-token: write
            contents: read

        steps:
            - name: Checkout repository
                uses: actions/checkout@v4
            - name: Install Nix
                uses: DeterminateSystems/nix-installer-action@main
                with:
                    determinate: true
            - name: Cache
                uses: DeterminateSystems/flakehub-cache-action@main
            - name: Check flake
                uses: DeterminateSystems/flake-checker-action@v9
            - name: Build
                run: nix build .#nixosConfigurations.${{ matrix.hostname }}.config.system.build.toplevel -L